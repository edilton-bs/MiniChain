<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mini Blockchain</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <h1>Mini Blockchain</h1>

    <!-- Div para exibir a blockchain -->
    <div id="blockchain">
        <!-- Os blocos serão carregados aqui -->
    </div>

    <!-- Formulário para adicionar um novo bloco -->
    <div id="new-block-form">
        <input type="text" id="novo-dado" placeholder="Dados do novo bloco">
        <button onclick="adicionarBloco()">Adicionar Novo Bloco</button>
    </div>

    <script>
        let debounceTimeout;

        function criarBlocoGenesis() {
            fetch('/criar_bloco_genesis', {
                method: 'POST'
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    carregarBlockchain();
                } else {
                    alert(data.message);
                }
            });
        }

        function adicionarBloco() {
            const dados = document.getElementById('novo-dado').value;
            fetch('/adicionar_bloco', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({dados})
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    carregarBlockchain();
                    document.getElementById('novo-dado').value = '';
                }
            });
        }

        function atualizarDados(indice) {
            const dados = document.getElementById(`dados-${indice}`).value;

            clearTimeout(debounceTimeout);

            debounceTimeout = setTimeout(() => {
                fetch('/atualizar_dados', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({indice, dados})
                }).then(response => response.json()).then(data => {
                    carregarBlockchain();
                });
            }, 300);
        }

        function atualizarNonce(indice) {
            const nonce = document.getElementById(`nonce-${indice}`).value;

            clearTimeout(debounceTimeout);

            debounceTimeout = setTimeout(() => {
                fetch('/atualizar_nonce', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({indice, nonce})
                }).then(response => response.json()).then(data => {
                    carregarBlockchain();
                });
            }, 300);
        }

        function minerarBloco(indice) {
            fetch('/minerar_bloco', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({indice})
            }).then(response => response.json()).then(data => {
                carregarBlockchain();
            });
        }

        function carregarBlockchain() {
            fetch('/get_blockchain').then(response => response.json()).then(data => {
                const blockchainDiv = document.getElementById('blockchain');
                blockchainDiv.innerHTML = '';  // Limpa a div antes de adicionar os blocos

                let invalidChain = false;  // Flag para marcar a cadeia inválida

                data.forEach(bloco => {
                    const blocoDiv = document.createElement('div');
                    blocoDiv.className = 'block';

                    // Verifica se o hash do bloco é válido (começa com "0000")
                    if (invalidChain || !bloco.hash.startsWith("0000")) {
                        blocoDiv.classList.add('invalid');
                        invalidChain = true;  // Marca todos os blocos seguintes como inválidos
                    }

                    blocoDiv.innerHTML = `
                        <h3>Bloco #${bloco.indice}</h3>
                        <label>Dados:</label>
                        <input type="text" id="dados-${bloco.indice}" value="${bloco.dados}" oninput="atualizarDados(${bloco.indice})">
                        <br>
                        <label>Hash anterior:</label>
                        <input type="text" id="previous-hash-${bloco.indice}" value="${bloco.hash_anterior}" readonly>
                        <br>
                        <label>Hash:</label>
                        <input type="text" id="hash-${bloco.indice}" value="${bloco.hash}" readonly>
                        <br>
                        <label>Nonce:</label>
                        <input type="number" id="nonce-${bloco.indice}" value="${bloco.nonce}" oninput="atualizarNonce(${bloco.indice})">
                        <button onclick="minerarBloco(${bloco.indice})">Minerar bloco</button>
                    `;
                    blockchainDiv.appendChild(blocoDiv);
                });
            });
        }

        // Carregar a blockchain ao iniciar
        window.onload = carregarBlockchain;
    </script>
</body>
</html>
